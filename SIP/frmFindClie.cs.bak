using System;
using System.Globalization;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using ulp_bl;
using SIP.Utiles;
using System.IO;
using System.Security.AccessControl;
using System.Security.Principal;

namespace SIP
{
    public partial class frmFindClie : Form
    {
        Enumerados.TipoTareaProcesamiento tipoTarea = new Enumerados.TipoTareaProcesamiento();
        Enumerados.TipoPedido tipoPedido = new Enumerados.TipoPedido();
        //AddPartidasPedi frmAgregarPartidas;
        AddPartidasPedi2 frmAgregarPartidas;
        frmInputBox f;
        bool _otroTipoPrendaInidicado = false;
        bool _otroTipoComposicionInidicado = false;
        bool _otroTipoColorInidicado = false;

        Reportes.frmReportes frmReportes;
        Precarga precarga;
        private Timer tmrCargaDatos = new Timer();
        private string id_Cliente = "";
        string nombre_vendedor = "";
        string clave_cliente = "";
        string status = "A";
        bool ordenTrabajoNueva;
        bool pedidoNuevo;
        bool pedidoDATNuevo;
		bool solicitudNueva;
        String _observaciones;
        bool logotipoNuevo = false;
        bool huboCambiosEnPedido;
        private string CURR_COD_CLIENTE = "";
        private int CURR_SELECTED_NDX = 0;
        private int PREV_SELECTED_NDX = 0;
        string Termino;
        string Agente;
        DataTable pedidos = new DataTable("PED_MSTR");
        DataTable pedidosDAT = new DataTable("PED_MSTR");
        DataTable logotipos = new DataTable("IMAGENES");
        DataTable logotiposOri = new DataTable("IMAGENES_ORI");
        DataTable OrdenTrabajo = new DataTable("PED_MSTR");
        List<TextBox> txtPedSipAValidar = new List<TextBox>();
        List<ComboBox> cmbPedSipAValidar = new List<ComboBox>();
        List<TextBox> txtPedDATSipAValidar = new List<TextBox>();
        List<ComboBox> cmbPedDATSipAValidar = new List<ComboBox>();
        List<TextBox> txtLogosAValidar = new List<TextBox>();
        private Timer tmrTextBoxHilight;

        BackgroundWorker bgwInfoCliente = new BackgroundWorker();
        BackgroundWorker backgroundWorker = new BackgroundWorker();
        private bool DatosCrgados;

        private bool accesaTab1;
        private bool accesaTab2;
        private bool accesaTab3;
        private bool accesaTab4;
        private bool accesaTab5;
        private bool accesaTab6;
        private Dictionary<int, bool> accesosTabs = new Dictionary<int, bool>();
        #region PedidosSIP
        private void PedidosSIPHabilitaControlesNavegacionParaPrimerRegistro(bool Habilita)
        {
            toolStripBtnPedidosSIPGuardar.Enabled = Habilita;
            toolStripBtnPedidosSIPEliminar.Enabled = Habilita;
        }
        private void PedidosSIPHabilitaControlesNavegacion(bool Habilita)
        {
            bindingNavigatorMoveFirstItem.Enabled = Habilita;
            bindingNavigatorMovePreviousItem.Enabled = Habilita;
            bindingNavigatorMoveNextItem.Enabled = Habilita;
            bindingNavigatorMoveLastItem.Enabled = Habilita;
            toolStripBtnPedidosSIPNuevo.Enabled = Habilita;
            bindingNavigatorPositionItem.Enabled = Habilita;
        }
        private void PedidosSIPHabilitaControlesCambios(bool Habilita)
        {
            lblPedSIPYaImpreso.Visible = !Habilita;
            txtPedSIPOc.Enabled = Habilita;
            txtPedSIPRemitido.Enabled = Habilita;
            txtPedSIPConsignado.Enabled = Habilita;
            txtPedSIPObservaciones.Enabled = Habilita;
            btnPedSIPAgregarPartidas.Enabled = Habilita;
            btnPedSIPElimModPartidas.Enabled = Habilita;
            btnPedSIPTerminosActualiza.Enabled = Habilita;
            toolStripBtnPedidosSIPGuardar.Enabled = Habilita;
            btnPedSIPImprimir.Enabled = Habilita;
        }
        private void PedidosSIPEvaluaHabilitarControlesCambios()
        {
            if (bindingSourcePedidosSIP.Count > 0)
            {
                DataRowView row = (DataRowView)bindingSourcePedidosSIP.Current;
                string status = row["ESTATUS"].ToString();
                if (status == "I")
                {
                    PedidosSIPHabilitaControlesCambios(false);
                    btnPedSIPImprimir.Enabled = true;
                }
                else
                {
                    PedidosSIPHabilitaControlesCambios(true);
                }
            }
            else
            {
                PedidosSIPHabilitaControlesNavegacionParaPrimerRegistro(false);
                PedidosSIPHabilitaControlesCambios(false);
                lblPedSIPYaImpreso.Visible = false;
            }
        }
        private void PedidosSIPLlenaDatos(string id)
        {
            PED_MSTR pedidosBl = new PED_MSTR();
            pedidos = pedidosBl.CosultarPedidosCliente(id);
            bindingSourcePedidosSIP.DataSource = pedidos;

            txtPedSIPNo.DataBindings.Add("Text", bindingSourcePedidosSIP, "PEDIDO");
            txtPedSIPFecha.DataBindings.Add("Text", bindingSourcePedidosSIP, "FECHA");
            txtPedSIPAgente.DataBindings.Add("Text", bindingSourcePedidosSIP, "AGENTE");
            txtPedSIPCliente.DataBindings.Add("Text", bindingSourcePedidosSIP, "CLIENTE");
            txtPedSIPOc.DataBindings.Add("Text", bindingSourcePedidosSIP, "OC");
            txtPedSIPTerminos.DataBindings.Add("Text", bindingSourcePedidosSIP, "TERMINOS");
            txtPedSIPRemitido.DataBindings.Add(new Binding("Text", bindingSourcePedidosSIP, "REMITIDO", true));
            txtPedSIPConsignado.DataBindings.Add(new Binding("Text", bindingSourcePedidosSIP, "CONSIGNADO", true));
            txtPedSIPObservaciones.DataBindings.Add(new Binding("Text", bindingSourcePedidosSIP, "OBSERVACIONES", true));
            cmbPedSIPFormaPago.DataBindings.Add(new Binding("SelectedValue", bindingSourcePedidosSIP, "FORMADEPAGOSAT", true));
            cmbPedSIPUsoCFDI.DataBindings.Add(new Binding("SelectedValue", bindingSourcePedidosSIP, "USO_CFDI", true));
            cmbPedSIPMetodoPago.DataBindings.Add(new Binding("SelectedValue", bindingSourcePedidosSIP, "METODODEPAGO", true));



            bindingNavigatorPedidosSIP.BindingSource = bindingSourcePedidosSIP;
            PedidosSIPEvaluaHabilitarControlesCambios();
            txtPedSipAValidar.Add(txtPedSIPRemitido);
            cmbPedSipAValidar.Add(cmbPedSIPFormaPago);
            cmbPedSipAValidar.Add(cmbPedSIPUsoCFDI);
            cmbPedSipAValidar.Add(cmbPedSIPMetodoPago);
        }
        private string PedidosSIPModificar()
        {
            string resultado = "";
            PED_MSTR pedidoModifica = new PED_MSTR();
            pedidoModifica.OC = txtPedSIPOc.Text;
            pedidoModifica.TERMINOS = txtPedSIPTerminos.Text;
            pedidoModifica.REMITIDO = txtPedSIPRemitido.Text;
            pedidoModifica.CONSIGNADO = txtPedSIPConsignado.Text;
            pedidoModifica.OBSERVACIONES = txtPedSIPObservaciones.Text;
            pedidoModifica.PEDIDO = Convert.ToInt32(txtPedSIPNo.Text);
            pedidoModifica.FORMADEPAGOSAT = cmbPedSIPFormaPago.SelectedValue.ToString();
            pedidoModifica.USO_CFDI = cmbPedSIPUsoCFDI.SelectedValue.ToString();
            pedidoModifica.METODODEPAGO = cmbPedSIPMetodoPago.SelectedValue.ToString();
            pedidoModifica.Modificar(pedidoModifica);
            if (pedidoModifica.TieneError)
            {
                resultado = pedidoModifica.Error.InnerException.ToString();
            }
            return resultado;
        }

        private string PedidosSIPGuardar()
        {
            string resultado = "";
            int pedido = 0;
            PED_MSTR guardaPedido = new PED_MSTR();
            guardaPedido.AGENTE = Agente;
            guardaPedido.FECHA = Convert.ToDateTime(txtPedSIPFecha.Text);
            guardaPedido.CLIENTE = txtPedSIPCliente.Text;
            guardaPedido.OC = txtPedSIPOc.Text;
            guardaPedido.TERMINOS = Termino;
            guardaPedido.REMITIDO = txtPedSIPRemitido.Text;
            guardaPedido.CONSIGNADO = txtPedSIPConsignado.Text;
            guardaPedido.OBSERVACIONES = txtPedSIPObservaciones.Text;
            guardaPedido.TIPO = "OV";
            guardaPedido.LISTA = 1;
            guardaPedido.ESTATUS = "P";
            guardaPedido.FORMADEPAGOSAT = cmbPedSIPFormaPago.SelectedValue.ToString();
            guardaPedido.USO_CFDI = cmbPedSIPUsoCFDI.SelectedValue.ToString();
            guardaPedido.METODODEPAGO = cmbPedSIPMetodoPago.SelectedValue.ToString();
            guardaPedido.Crear(guardaPedido, ref pedido);
            if (!guardaPedido.TieneError)
            {
                UPPEDIDOS guardaUppedidos = new UPPEDIDOS();
                guardaUppedidos.PEDIDO = pedido;
                guardaUppedidos.COD_CLIENTE = clave_cliente;
                guardaUppedidos.F_CAPT = DateTime.Now;
                guardaUppedidos.Crear(guardaUppedidos);

                txtPedSIPNo.Text = pedido.ToString();
                pedidos.Rows[pedidos.Rows.Count - 1]["PEDIDO"] = pedido;
            }
            else
            {
                resultado = guardaPedido.Error.InnerException.ToString();
            }
            return resultado;
        }

        private void btnPedSIPTerminosActualiza_Click(object sender, EventArgs e)
        {
            txtPedSIPTerminos.Text = Termino;
            string resultado = "";
            resultado = PedidosSIPModificar();
            if (resultado != "")
            {
                MessageBox.Show("Se presentó el siguiente error \\n" + resultado, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }
        private void toolStripBtnPedidosSIPNuevo_Click(object sender, EventArgs e)
        {
            pedidoNuevo = true;

            DataRow nuevo_pedido = pedidos.NewRow();
            pedidos.Rows.Add(nuevo_pedido);
            nuevo_pedido["FECHA"] = DateTime.Now;
            nuevo_pedido["AGENTE"] = Agente;
            nuevo_pedido["CLIENTE"] = clave_cliente;
            nuevo_pedido["OC"] = "";
            nuevo_pedido["TERMINOS"] = Termino;
            nuevo_pedido["ESTATUS"] = "P";
            nuevo_pedido["FORMADEPAGOSAT"] = "03";
            nuevo_pedido["METODODEPAGO"] = "PUE";
            nuevo_pedido["USO_CFDI"] = "G01";
            bindingSourcePedidosSIP.MoveLast();

            PedidosSIPHabilitaControlesNavegacion(false);
            PedidosSIPHabilitaControlesCambios(true);
            btnPedSIPAgregarPartidas.Enabled = false;
            btnPedSIPElimModPartidas.Enabled = false;
            btnPedSIPTerminosActualiza.Enabled = false;
            btnPedSIPImprimir.Enabled = false;
            PedidosSIPHabilitaControlesNavegacionParaPrimerRegistro(true);
            txtPedSIPOc.Focus();
        }
        private void toolStripBtnPedidosSIPGuardar_Click(object sender, EventArgs e)
        {
            if (!GeneralesExistenDatosVacios(txtPedSipAValidar) && !GeneralesExistenDatosVacios(cmbPedSipAValidar))
            {
                string resultado = "";
                if (pedidoNuevo)
                {
                    resultado = PedidosSIPGuardar();
                }
                else
                {
                    resultado = PedidosSIPModificar();
                }

                if (resultado == "")
                {
                    PedidosSIPHabilitaControlesNavegacion(true);
                    PedidosSIPHabilitaControlesCambios(true);
                    pedidoNuevo = false;
                }
                else
                {
                    MessageBox.Show("Se presentó el siguiente error \\n" + resultado, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }

        }
        private void toolStripBtnPedidosSIPEliminar_Click(object sender, EventArgs e)
        {
            if (!pedidoNuevo)
            {
                PED_DET detalle_pedido = new PED_DET();
                int idPedido = Convert.ToInt32(txtPedSIPNo.Text);
                bool contiene_partidas = detalle_pedido.ContieneRegistrosPedido(idPedido);
                if (!contiene_partidas)
                {
                    if (MessageBox.Show("Está seguro que desea eliminar el pedido?", "", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
                    {
                        PED_MSTR elimina_pedido = new PED_MSTR();
                        elimina_pedido.PEDIDO = idPedido;
                        elimina_pedido.Borrar(elimina_pedido, Enumerados.TipoBorrado.Fisico);
                        bindingSourcePedidosSIP.RemoveCurrent();
                        MessageBox.Show("El pedido ha sido eliminado.", "Información", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                }
                else
                {
                    MessageBox.Show("No se puede eliminar el pedido debido a que ya tiene partidas cargadas.\n\n Debe eliminar las partidas desde el botón (Eliminar o Modificar Partidas) y luego podrá eliminar el pedido", "Información", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
            else
            {
                bindingSourcePedidosSIP.RemoveCurrent();
                PedidosSIPHabilitaControlesNavegacion(true);
                PedidosSIPEvaluaHabilitarControlesCambios();
                pedidoNuevo = false;
            }
            if (bindingSourcePedidosSIP.Count == 0)
            {
                PedidosSIPHabilitaControlesNavegacionParaPrimerRegistro(false);
            }

        }

        private void btnPedSIPElimModPartidas_Click(object sender, EventArgs e)
        {
            frmEliminarPartidas frmEliminarPartidas = new frmEliminarPartidas(clave_cliente, Convert.ToInt32(txtPedSIPNo.Text), Enumerados.TipoPedido.Pedido);
            frmEliminarPartidas.Show();
        }

        private void btnPedSIPAgregarPartidas_Click(object sender, EventArgs e)
        {

            if (!string.IsNullOrEmpty(txtPedSIPCliente.Text))
            {
                /*
                frmAgregarPartidas = new AddPartidasPedi(txtPedSIPCliente.Text,
                    Convert.ToInt32(txtPedSIPNo.Text), Enumerados.TipoPedido.Pedido, nombre_vendedor);
                frmAgregarPartidas.Show();
                 * */
                frmAgregarPartidas = new AddPartidasPedi2(txtPedSIPCliente.Text, Convert.ToInt32(txtPedSIPNo.Text), Enumerados.TipoPedido.Pedido, nombre_vendedor);
                frmAgregarPartidas.Show();
            }
        }

        private void bindingNavigatorMovePreviousItem_Click(object sender, EventArgs e)
        {
            PedidosSIPEvaluaHabilitarControlesCambios();
        }

        private void bindingNavigatorMoveFirstItem_Click(object sender, EventArgs e)
        {
            PedidosSIPEvaluaHabilitarControlesCambios();
        }

        private void bindingNavigatorMoveNextItem_Click(object sender, EventArgs e)
        {
            PedidosSIPEvaluaHabilitarControlesCambios();
        }

        private void bindingNavigatorMoveLastItem_Click(object sender, EventArgs e)
        {
            PedidosSIPEvaluaHabilitarControlesCambios();
        }
        private void bindingNavigatorAddNewItem_Click(object sender, EventArgs e)
        {
        }
        private void btnPedSIPImprimir_Click(object sender, EventArgs e)
        {
            if (pedidos.Rows[bindingSourcePedidosSIP.Position]["PEDIDO"] != DBNull.Value)
            {
                int idPedido = Convert.ToInt32(pedidos.Rows[bindingSourcePedidosSIP.Position]["PEDIDO"].ToString());
                string status = pedidos.Rows[bindingSourcePedidosSIP.Position]["ESTATUS"].ToString();
                frmReportes = new Reportes.frmReportes(Enumerados.TipoReporteCrystal.Pedidos,
                    clave_cliente, 0, idPedido, Enumerados.TipoPedido.Pedido);
                if (status == "I")
                {
                    frmReportes.enVentas = true;
                }
                frmReportes.Show();
            }
        }

        #endregion "Código para Pedidos SIP"

        #region Logotipos

        private void LogotiposLlenaDatos()
        {
            IMAGENES imagenes = new IMAGENES();
            logotipos = imagenes.ConsultarPorCliente(clave_cliente);
            logotiposOri = logotipos.Copy();
            bindingSourceLogotipos.DataSource = logotipos;
            txtLogoCliente.DataBindings.Add("Text", bindingSourceLogotipos, "COD_CLIENTE");
            txtLogoCodCatalogo.DataBindings.Add("Text", bindingSourceLogotipos, "COD_CATALOGO");
            txtLogoColor1.DataBindings.Add("Text", bindingSourceLogotipos, "COLOR_1");
            txtLogoColor2.DataBindings.Add("Text", bindingSourceLogotipos, "COLOR_2");
            txtLogoColor3.DataBindings.Add("Text", bindingSourceLogotipos, "COLOR_3");
            txtLogoColor4.DataBindings.Add("Text", bindingSourceLogotipos, "COLOR_4");
            txtLogoColor5.DataBindings.Add("Text", bindingSourceLogotipos, "COLOR_5");
            txtLogoColor6.DataBindings.Add("Text", bindingSourceLogotipos, "COLOR_6");
            txtLogoComentarios.DataBindings.Add("Text", bindingSourceLogotipos, "COMENTARIOS");
            txtLogoPuntadas.DataBindings.Add("Text", bindingSourceLogotipos, "PUNTADAS");
            txtLogoNomArch.DataBindings.Add("Text", bindingSourceLogotipos, "NAME");
            LogotiposCalculaPosicionRegistros();
            if (bindingSourceLogotipos.Count == 0)
            {
                LogotiposHabilitaControles(false);
                btnLogoNuevReg.Enabled = true;
                btnLogoSalvar.Enabled = false;
                btnLogoBorrar.Enabled = false;
            }
            txtLogosAValidar.Add(txtLogoComentarios);
            txtLogosAValidar.Add(txtLogoCodCatalogo);

        }
        private string LogotiposDevuelveNombreImagen()
        {
            string nombreImagen = "";
            if (bindingSourceLogotipos.Count > 0)
            {
                DataRowView row = (DataRowView)bindingSourceLogotipos.Current;
                string id = row["ID"].ToString();
                nombreImagen = "CL" + clave_cliente + "-ID" + id + ".jpg";
            }
            return nombreImagen;
        }
        private string LogotiposDevuelveNombreImagen(string idArchivo)
        {
            string nombreImagen = "";
            if (idArchivo != "")
            {
                nombreImagen = "CL" + clave_cliente + "-ID" + idArchivo + ".jpg";
            }
            return nombreImagen;
        }
        private void LogotiposHabilitaControles(bool Habilita)
        {
            lstViewLogotipos.Enabled = Habilita;
            btnLogoCambImg.Enabled = Habilita;
            btnLogoImprimir.Enabled = Habilita;
            btnLogoNuevReg.Enabled = Habilita;
        }

        private int LogotiposGuardaInfo()
        {
            int id = 0;
            IMAGENES guarda_inf_imagen = new IMAGENES();
            guarda_inf_imagen.COD_CATALOGO = txtLogoCodCatalogo.Text;
            guarda_inf_imagen.COD_CLIENTE = txtLogoCliente.Text;
            guarda_inf_imagen.COLOR_1 = txtLogoColor1.Text;
            guarda_inf_imagen.COLOR_2 = txtLogoColor2.Text;
            guarda_inf_imagen.COLOR_3 = txtLogoColor3.Text;
            guarda_inf_imagen.COLOR_4 = txtLogoColor4.Text;
            guarda_inf_imagen.COLOR_5 = txtLogoColor5.Text;
            guarda_inf_imagen.COLOR_6 = txtLogoColor6.Text;
            guarda_inf_imagen.COMENTARIOS = txtLogoComentarios.Text;
            guarda_inf_imagen.NAME = txtLogoNomArch.Text;
            int puntadas = 0;
            int.TryParse(txtLogoPuntadas.Text, out puntadas);
            guarda_inf_imagen.PUNTADAS = puntadas;
            guarda_inf_imagen.Crear(guarda_inf_imagen, ref id);
            return id;
        }
        private void LogotiposModificaInfo()
        {
            DataRow row = logotipos.Rows[bindingSourceLogotipos.Position];
            int id = Convert.ToInt32(row["id"].ToString());
            IMAGENES modifica_inf_imagen = new IMAGENES();
            modifica_inf_imagen.ID = id;
            modifica_inf_imagen.COD_CATALOGO = txtLogoCodCatalogo.Text;
            modifica_inf_imagen.COD_CLIENTE = txtLogoCliente.Text;
            modifica_inf_imagen.COLOR_1 = txtLogoColor1.Text;
            modifica_inf_imagen.COLOR_2 = txtLogoColor2.Text;
            modifica_inf_imagen.COLOR_3 = txtLogoColor3.Text;
            modifica_inf_imagen.COLOR_4 = txtLogoColor4.Text;
            modifica_inf_imagen.COLOR_5 = txtLogoColor5.Text;
            modifica_inf_imagen.COLOR_6 = txtLogoColor6.Text;
            modifica_inf_imagen.COMENTARIOS = txtLogoComentarios.Text;
            modifica_inf_imagen.NAME = txtLogoNomArch.Text;
            int puntadas = 0;
            int.TryParse(txtLogoPuntadas.Text, out puntadas);
            modifica_inf_imagen.PUNTADAS = puntadas;
            modifica_inf_imagen.Modificar(modifica_inf_imagen);
        }
        private string LogotiposDevuelveRutaImagenSeleccionada()
        {
            string rutaArchivo = "";
            OpenFileDialog archivo = new OpenFileDialog();
            archivo.InitialDirectory = @"c:\";
            archivo.Filter = "Archivos JPG (*.jpg)|*.jpg";
            if (archivo.ShowDialog() == DialogResult.OK)
            {
                rutaArchivo = archivo.FileName;
            }
            return rutaArchivo;
        }

        private Image LogotiposDevuelveImagen(string ruta, string archivo)
        {
            // string ImagenADesplegar = Directory.GetCurrentDirectory().ToString() + @" \Imagenes\sin_imagen.jpg";
            string ImagenADesplegar = "";
            Image imgADevolver = Properties.Resources.sin_imagen;
            if (Directory.Exists(ruta))
            {
                if (File.Exists(ruta + archivo))
                {
                    ImagenADesplegar = ruta + archivo;
                    imgADevolver = null;
                    using (Stream img = File.OpenRead(ImagenADesplegar))
                    {
                        imgADevolver = Image.FromStream(img);
                    }
                }

            }
            return imgADevolver;
        }

        private void LogotiposEliminaImagen(string ruta)
        {
            if (File.Exists(ruta))
            {
                /*
                FileSecurity fileSecurity = new System.Security.AccessControl.FileSecurity();
                FileInfo fInfo = new FileInfo(rutaDestino + archivoDestino);
                fileSecurity.RemoveAccessRuleAll(new System.Security.AccessControl.FileSystemAccessRule(new SecurityIdentifier(WellKnownSidType.WorldSid, null), 
                                         FileSystemRights.Delete,
                                         InheritanceFlags.ObjectInherit | InheritanceFlags.ContainerInherit,
                                         PropagationFlags.NoPropagateInherit, AccessControlType.Allow));                             
                fInfo.SetAccessControl(fileSecurity);
               */

                File.Delete(ruta);
            }
        }

        private void LogotiposCopiaImagenACarpeta(string rutaOrigen, string rutaDestino, string archivoDestino)
        {
            if (rutaOrigen != "")
            {
                if (!Directory.Exists(rutaDestino))
                {
                    Directory.CreateDirectory(rutaDestino);
                }
                else
                {
                    LogotiposEliminaImagen(rutaDestino + archivoDestino);
                }
                File.Copy(rutaOrigen, rutaDestino + archivoDestino);
            }
        }

        private void LogotiposCalculaPosicionRegistros()
        {

            lblLogoTotReg.Text = string.Format("{0} de {1}", (bindingSourceLogotipos.Position + 1).ToString(), bindingSourceLogotipos.Count.ToString());

            if (lstViewLogotipos.Items.Count > 0 && bindingSourceLogotipos.Position <= lstViewLogotipos.Items.Count - 1)
            {
                int pos = bindingSourceLogotipos.Position;
                lstViewLogotipos.Items[pos].Focused = true;
                lstViewLogotipos.Items[pos].Selected = true;
            }

        }
        private void LogotiposCargaListViewConImagenes(int idASeleccionar)
        {
            imgLstLogotipos.Images.Clear();
            lstViewLogotipos.Clear();
            lstViewLogotipos.Focus();

            foreach (DataRow row in logotipos.Rows)
            {
                string nombreArchivo = LogotiposDevuelveNombreImagen(row["id"].ToString());
                Image img = LogotiposDevuelveImagen(Globales.rutaImagenes, nombreArchivo);
                try
                {
                    try
                    {
                        Graphics g = Graphics.FromImage(img);
                        g.DrawRectangle(new Pen(SystemBrushes.ActiveBorder, 2), new Rectangle(0, 0, img.Width - 1, img.Height - 1));
                    }
                    catch { }

                    imgLstLogotipos.Images.Add(row["id"].ToString(), img);
                }
                catch (Exception Ex)
                {
                    //MessageBox.Show(
                    //    string.Format("El archivo: \"{0}\" parece estar dañado o es demasiado grande", nombreArchivo),
                    //    Ex.Message, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                    //Image imgDefault = LogotiposDevuelveImagen(Directory.GetCurrentDirectory().ToString() + @" \Imagenes\", "archivo_danado.png");
                    Image imgDefault = SIP.Properties.Resources.archivo_danado;
                    imgLstLogotipos.Images.Add(imgDefault);
                }
            }
            lstViewLogotipos.View = View.LargeIcon;
            //imgLstLogotipos.ImageSize = new Size(120, 100);
            //imgLstLogotipos.ImageSize = new Size(120, 100);
            imgLstLogotipos.ImageSize = new Size(120, 120);

            lstViewLogotipos.LargeImageList = imgLstLogotipos;

            string codCatalogo = "";
            for (int j = 0; j < imgLstLogotipos.Images.Count; j++)
            {

                ; if (imgLstLogotipos.Images.Keys[j] != "")
                {
                    var cod_logo = (from c in logotipos.AsEnumerable()
                                    where (int)c["ID"] == int.Parse(imgLstLogotipos.Images.Keys[j])
                                    select new { COD_CATALOGO = c["COD_CATALOGO"].ToString() }).FirstOrDefault();

                    codCatalogo = cod_logo.COD_CATALOGO.Trim();

                }
                else
                {
                    codCatalogo = "Archivo dañado!";

                }
                ListViewItem item = new ListViewItem();
                item.Font = new System.Drawing.Font(FontFamily.GenericSansSerif, 14f, FontStyle.Bold);
                item.ImageKey = j.ToString();
                //item.Text = (j + 1).ToString();
                item.Text = codCatalogo;
                item.ImageIndex = j;
                lstViewLogotipos.Items.Add(item);
                if (j == idASeleccionar)
                {
                    lstViewLogotipos.Items[j].Focused = true;
                    lstViewLogotipos.Items[j].Selected = true;
                    lstViewLogotipos.Items[j].EnsureVisible();
                }
            }
        }

        private void btnLogoPrevio_Click(object sender, EventArgs e)
        {
        }
        private void lstViewLogotipos_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (!logotipoNuevo)
            {

                if (lstViewLogotipos.SelectedItems.Count > 0)
                {

                    ListViewItem lv = lstViewLogotipos.SelectedItems[0];

                    CURR_COD_CLIENTE = lv.Text;
                    PREV_SELECTED_NDX = CURR_SELECTED_NDX;

                    CURR_SELECTED_NDX = lv.Index;
                    bindingSourceLogotipos.Position = lv.ImageIndex;

                    LogotiposCalculaPosicionRegistros();


                }
                else
                {
                    CURR_COD_CLIENTE = "";
                }

            }

        }

        private void lstViewLogotipos_DoubleClick(object sender, EventArgs e)
        {

            DataRow row = logotipos.Rows[bindingSourceLogotipos.Position];
            string archivo = Globales.rutaImagenes + LogotiposDevuelveNombreImagen(row["id"].ToString());
            if (File.Exists(archivo))
            {
                System.Diagnostics.Process.Start(archivo);
            }
            else
            {
                MessageBox.Show("No hay imágen a desplegar", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }

            //frmImagen frmImagen = new frmImagen(LogotiposDevuelveImagen(Directory.GetCurrentDirectory().ToString() + @" \CliesLogos\", LogotiposDevuelveNombreImagen(row["id"].ToString())));
            // frmImagen.ShowDialog();                
        }

        private void btnLogoNuevReg_Click(object sender, EventArgs e)
        {
            logotipoNuevo = true;
            //Random rnd = new Random();
            DataRow rowLog = logotipos.NewRow();

            logotipos.Rows.Add(rowLog);
            rowLog["COD_CLIENTE"] = clave_cliente;
            //rowLog["COD_CATALOGO"] = "Rnd-" + Convert.ToString(Convert.ToInt32(255 * rnd.NextDouble() + 1));
            rowLog["COD_CATALOGO"] = clave_cliente + "-";

            bindingSourceLogotipos.MoveLast();
            LogotiposHabilitaControles(false);
            btnLogoSalvar.Enabled = true;
            btnLogoBorrar.Enabled = true;
            btnLogoBorrar.Text = "Cancelar";
            LogotiposCalculaPosicionRegistros();
            txtLogoCodCatalogo.SelectAllOnFocus = false;
            txtLogoCodCatalogo.SelectionStart = txtLogoCodCatalogo.Text.Length;
            txtLogoCodCatalogo.Focus();
            txtLogoCodCatalogo.SelectAllOnFocus = true;
        }

        private void btnLogoCambImg_Click(object sender, EventArgs e)
        {
            if (lstViewLogotipos.SelectedItems.Count == 0)
            {
                MessageBox.Show("Seleccione una imagen", "", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }
            string rutaOrigen = LogotiposDevuelveRutaImagenSeleccionada();
            if (rutaOrigen != string.Empty)
            {
                DataRowView row = (DataRowView)bindingSourceLogotipos.Current;
                string id = row["ID"].ToString();
                string nombreArchivo = "CL" + clave_cliente + "-ID" + id + ".jpg";
                //string rutaDestino = Directory.GetCurrentDirectory().ToString() + @" \CliesLogos\";                
                LogotiposCopiaImagenACarpeta(rutaOrigen, Globales.rutaImagenes, nombreArchivo);
                LogotiposCargaListViewConImagenes(bindingSourceLogotipos.Position);
                MessageBox.Show("Imagen modificada", "", MessageBoxButtons.OK, MessageBoxIcon.Information);
                txtLogoCodCatalogo.Focus();
            }
        }



        private void btnLogoSalvar_Click(object sender, EventArgs e)
        {

            string respuestaErrCodCat = "";
            if (!GeneralesExistenDatosVacios(txtLogosAValidar))
            {

                respuestaErrCodCat = LogosVAlidaCodigoCatalogo();
                if (respuestaErrCodCat == "")
                {
                    if (logotipoNuevo)
                    {
                        string rutaOrigen = LogotiposDevuelveRutaImagenSeleccionada();



                        if (rutaOrigen != string.Empty)
                        {

                            string id = LogotiposGuardaInfo().ToString();
                            string nombreArchivo = "CL" + clave_cliente + "-ID" + id + ".jpg";
                            //string rutaDestino = Directory.GetCurrentDirectory().ToString() + @" \CliesLogos\";
                            LogotiposCopiaImagenACarpeta(rutaOrigen, Globales.rutaImagenes, nombreArchivo);
                            DataRow row = logotipos.Rows[bindingSourceLogotipos.Position];
                            row["id"] = id;
                            LogotiposCargaListViewConImagenes(bindingSourceLogotipos.Position);
                            LogotiposHabilitaControles(true);
                            logotipoNuevo = false;

                            logotiposOri.Rows.Add(row.ItemArray);
                            LogotiposCalculaPosicionRegistros();
                            btnLogoBorrar.Text = "Borrar";
                            MessageBox.Show("Nuevo logotipo agregado", "", MessageBoxButtons.OK,
                                MessageBoxIcon.Information);
                        }

                    }
                    else
                    {

                        if (bindingSourceLogotipos.Count > 0)
                        {
                            if (lstViewLogotipos.SelectedItems.Count == 0)
                            {
                                MessageBox.Show("Seleccione una imagen", "", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                                return;
                            }
                            string msg = string.Format("¿Confirma modificar el Logotipo: \"{0}\" ?", lstViewLogotipos.SelectedItems[0].Text);
                            DialogResult respMoif = MessageBox.Show(msg, "Confirme", MessageBoxButtons.YesNo,
                                MessageBoxIcon.Question);
                            if (respMoif == System.Windows.Forms.DialogResult.Yes)
                            {
                                LogotiposModificaInfo();
                                LogotiposCalculaPosicionRegistros();
                                MessageBox.Show("Logotipo modificado", "", MessageBoxButtons.OK,
                                    MessageBoxIcon.Information);
                            }
                        }
                    }
                }
                else
                {
                    MessageBox.Show(respuestaErrCodCat, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    txtLogoCodCatalogo.Focus();
                }
            }

        }

        private void btnLogoBorrar_Click(object sender, EventArgs e)
        {



            if (!logotipoNuevo)
            {
                if (lstViewLogotipos.SelectedItems.Count == 0)
                {
                    MessageBox.Show("Seleccione una imagen a borrar", "", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }
                string msg = string.Format("¿Realmente desea eliminar el Logotipo: \"{0}\" ?", lstViewLogotipos.SelectedItems[0].Text);

                if (MessageBox.Show(msg, "Confirme", MessageBoxButtons.YesNo, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2) == DialogResult.Yes)
                {

                    IMAGENES img_a_borrar = new IMAGENES();
                    DataRowView registroActual = (DataRowView)bindingSourceLogotipos.Current;
                    int id = Convert.ToInt32(registroActual["ID"].ToString());
                    img_a_borrar.ID = id;
                    img_a_borrar.COD_CATALOGO = registroActual["COD_CATALOGO"].ToString();
                    img_a_borrar.Borrar(img_a_borrar, Enumerados.TipoBorrado.Fisico);
                    //bindingSourceLogotipos.RemoveCurrent();
                    logotipos.Rows.RemoveAt(bindingSourceLogotipos.Position);
                    try
                    {
                        var query = (from r in logotiposOri.AsEnumerable() where (int)r["ID"] == id select r).FirstOrDefault();
                        logotiposOri.Rows.Remove(query);
                    }
                    catch { }
                    string nombreArchivo = "CL" + clave_cliente + "-ID" + id + ".jpg";
                    string ruta = Globales.rutaImagenes;
                    LogotiposEliminaImagen(ruta + nombreArchivo);
                    LogotiposCargaListViewConImagenes(bindingSourceLogotipos.Position);
                    MessageBox.Show("El registro ha sido eliminado exitosamente.", "", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    logotipoNuevo = false;
                }
            }
            else
            {

                logotipos.Rows.RemoveAt(bindingSourceLogotipos.Position);
                logotipoNuevo = false;
                //bindingSourceLogotipos.RemoveCurrent();                    
            }
            if (logotipos.Rows.Count > 0)
            {
                LogotiposHabilitaControles(true);
            }
            else
            {
                LogotiposCargaListViewConImagenes(0);
                LogotiposHabilitaControles(false);
                btnLogoNuevReg.Enabled = true;
                btnLogoSalvar.Enabled = false;
                btnLogoBorrar.Enabled = false;
            }
            btnLogoBorrar.Text = "Borrar";
            LogotiposCalculaPosicionRegistros();
        }
        private void btnLogoImprimir_Click(object sender, EventArgs e)
        {
            if (lstViewLogotipos.SelectedItems.Count == 0)
            {
                MessageBox.Show("Seleccione una imagen", "", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }
            DataRowView registroActual = (DataRowView)bindingSourceLogotipos.Current;
            int ID = Convert.ToInt32(registroActual["ID"].ToString());
            Reportes.frmReportes frmReportes = new Reportes.frmReportes(Enumerados.TipoReporteCrystal.Logotipos, clave_cliente, ID, 0, Enumerados.TipoPedido.NoAplica);
            frmReportes.Show();
        }


        #endregion "Código correspondiente a logotipos"

        #region OrdenTrabajoSIP
        private void OrdenTrabSIPHabilitaControlesNavegacionParaPrimerRegistro(bool Habilita)
        {
            toolStripBtnOrdenTrabSIPEliminar.Enabled = Habilita;
            toolStripBtnOrdenTrabSIPGuardar.Enabled = Habilita;
        }
        private void OrdenTrabSIPHabilitaControlesNavegacion(bool Habilita)
        {
            bindingNavigatorMoveFirstItem1.Enabled = Habilita;
            bindingNavigatorMovePreviousItem1.Enabled = Habilita;
            bindingNavigatorMoveNextItem1.Enabled = Habilita;
            bindingNavigatorMoveLastItem1.Enabled = Habilita;
            toolStripBtnOrdenTrabSIPNuevo.Enabled = Habilita;
            bindingNavigatorPositionItem1.Enabled = Habilita;
            btnOrdenTrabSIPAgregarPartidas.Enabled = Habilita;
            btnOrdenTrabSIPEliminarPartidas.Enabled = Habilita;
        }
        private void OrdenTrabEvaluaHabilitarControlesCambios()
        {
            if (bindingSourceOrdenTrabSIP.Count > 0)
            {
                DataRowView row = (DataRowView)bindingSourceOrdenTrabSIP.Current;
                string status = row["ESTATUS"].ToString();
                if (status == "I")
                {
                    OrdenTrabHabilitaControlesCambios(false);
                }
                else
                {
                    OrdenTrabHabilitaControlesCambios(true);
                }
            }
            else
            {
                OrdenTrabSIPHabilitaControlesNavegacionParaPrimerRegistro(false);
            }
        }

        private void OrdenTrabHabilitaControlesCambios(bool Habilita)
        {
            lblOrdTrabYaImpreso.Visible = !Habilita;
            btnOrdenTrabSIPAgregarPartidas.Enabled = Habilita;
            btnOrdenTrabSIPEliminarPartidas.Enabled = Habilita;
        }
        private void OrdenTrabSIPLlenaDatos(string id)
        {
            PED_MSTR ordenTrabBl = new PED_MSTR();
            OrdenTrabajo = ordenTrabBl.ConsultarOrdenTrabajo(id);
            bindingSourceOrdenTrabSIP.DataSource = OrdenTrabajo;
            txtOrdenTrabSIPAgente.DataBindings.Add("Text", bindingSourceOrdenTrabSIP, "AGENTE");
            txtOrdenTrabSIPOT.DataBindings.Add("Text", bindingSourceOrdenTrabSIP, "PEDIDO");
            txtOrdenTrabSIPCliente.DataBindings.Add("Text", bindingSourceOrdenTrabSIP, "CLIENTE");
            txtOrdenTrabSIPFecha.DataBindings.Add("Text", bindingSourceOrdenTrabSIP, "FECHA");

            bindingNavigatorOrdenTrabSIP.BindingSource = bindingSourceOrdenTrabSIP;
            OrdenTrabEvaluaHabilitarControlesCambios();
        }

        private void OrdenTrabSIPGuardar()
        {
            int pedido = 0;
            PED_MSTR guardaPedido = new PED_MSTR();
            guardaPedido.AGENTE = Agente;
            guardaPedido.FECHA = DateTime.Now;
            guardaPedido.CLIENTE = clave_cliente;
            guardaPedido.ESTATUS = "P";
            guardaPedido.TIPO = "OT";
            guardaPedido.TERMINOS = Termino;
            guardaPedido.Crear(guardaPedido, ref pedido);

            UPPEDIDOS guardaUppedidos = new UPPEDIDOS();
            guardaUppedidos.PEDIDO = pedido;
            guardaUppedidos.COD_CLIENTE = clave_cliente;
            guardaUppedidos.F_CAPT = DateTime.Now;
            guardaUppedidos.Crear(guardaUppedidos);
            txtOrdenTrabSIPOT.Text = pedido.ToString();
            OrdenTrabajo.Rows[bindingSourceOrdenTrabSIP.Position]["PEDIDO"] = pedido;
        }

        private void toolStripBtnOrdenTrabSIPNuevo_Click(object sender, EventArgs e)
        {
            ordenTrabajoNueva = true;

            DataRow nueva_ot = OrdenTrabajo.NewRow();
            nueva_ot["FECHA"] = DateTime.Now;
            nueva_ot["AGENTE"] = Agente;
            nueva_ot["CLIENTE"] = clave_cliente;
            OrdenTrabajo.Rows.Add(nueva_ot);
            bindingSourceOrdenTrabSIP.MoveLast();

            OrdenTrabSIPHabilitaControlesNavegacion(false);
            OrdenTrabHabilitaControlesCambios(false);
            lblOrdTrabYaImpreso.Visible = false;
            OrdenTrabSIPHabilitaControlesNavegacionParaPrimerRegistro(true);
            toolStripBtnOrdenTrabSIPGuardar_Click(sender, e);
            //btnOrdenTrabSIPAgregarPartidas_Click(sender, e);

        }

        private void toolStripBtnOrdenTrabSIPGuardar_Click(object sender, EventArgs e)
        {
            if (ordenTrabajoNueva)
            {
                OrdenTrabSIPGuardar();
                OrdenTrabSIPHabilitaControlesNavegacion(true);
                OrdenTrabHabilitaControlesCambios(true);
                ordenTrabajoNueva = false;
            }
        }
        private void toolStripBtnOrdenTrabSIPEliminar_Click(object sender, EventArgs e)
        {
            if (!ordenTrabajoNueva)
            {
                PED_DET detalle_pedido = new PED_DET();
                int idPedido = Convert.ToInt32(txtOrdenTrabSIPOT.Text);
                bool contiene_partidas = detalle_pedido.ContieneRegistrosPedido(idPedido);
                if (!contiene_partidas)
                {
                    if (MessageBox.Show("Está seguro que desea eliminar la órden de trabajo?", "", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
                    {
                        PED_MSTR elimina_pedido = new PED_MSTR();
                        elimina_pedido.PEDIDO = idPedido;
                        elimina_pedido.Borrar(elimina_pedido, Enumerados.TipoBorrado.Fisico);
                        //bindingSourceOrdenTrabSIP.RemoveCurrent();
                        OrdenTrabajo.Rows.RemoveAt(bindingSourceOrdenTrabSIP.Position);
                        MessageBox.Show("la órden de trabajo ha sido eliminada.", "Información", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                }
                else
                {
                    MessageBox.Show("No se puede eliminar la órden de trabajo debido a que ya tiene partidas cargadas.\n\n Debe eliminar las partidas desde el botón (Eliminar Partidas) y luego podrá eliminar la órden de trabajo", "Información", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
            else
            {
                bindingSourceOrdenTrabSIP.RemoveCurrent();
                OrdenTrabSIPHabilitaControlesNavegacion(true);
                OrdenTrabEvaluaHabilitarControlesCambios();
                ordenTrabajoNueva = false;
            }
            if (bindingSourceOrdenTrabSIP.Count == 0)
            {
                OrdenTrabSIPHabilitaControlesNavegacionParaPrimerRegistro(false);
            }
        }

        private void btnOrdenTrabSIPAgregarPartidas_Click(object sender, EventArgs e)
        {
            if (!string.IsNullOrEmpty(txtOrdenTrabSIPOT.Text))
            {
                AddPartidasPedi frmAgregarPartidasOT = new AddPartidasPedi(clave_cliente,
                    Convert.ToInt32(txtOrdenTrabSIPOT.Text), Enumerados.TipoPedido.OrdenTrabajo, nombre_vendedor);
                frmAgregarPartidasOT.Show();
            }
        }

        private void btnOrdenTrabSIPEliminarPartidas_Click(object sender, EventArgs e)
        {

            frmEliminarPartidas frmEliminarPartidasOT = new frmEliminarPartidas(clave_cliente, Convert.ToInt32(txtOrdenTrabSIPOT.Text), Enumerados.TipoPedido.OrdenTrabajo);
            frmEliminarPartidasOT.Show();
        }
        private void btnOrdenTrabSIPImprimir_Click(object sender, EventArgs e)
        {
            if (OrdenTrabajo.Rows.Count > 0)
            {
                if (OrdenTrabajo.Rows[bindingSourceOrdenTrabSIP.Position]["PEDIDO"].ToString() != "")
                {

                    string status = OrdenTrabajo.Rows[bindingSourceOrdenTrabSIP.Position]["ESTATUS"].ToString();
                    int idPedido = Convert.ToInt32(OrdenTrabajo.Rows[bindingSourceOrdenTrabSIP.Position]["PEDIDO"].ToString());
                    frmReportes = new Reportes.frmReportes(Enumerados.TipoReporteCrystal.OrdenTrabajo, clave_cliente, 0, idPedido, Enumerados.TipoPedido.OrdenTrabajo, "frmFindClie");
                    if (status == "I")
                    {
                        frmReportes.enVentas = true;
                    }
                    frmReportes.Show();
                }
            }
        }
        #endregion "Código para órdenes de Trabajo"

        #region EstadoCuenta
        private void EstadoCuentaLlenaDatos(string id)
        {
            DataTable resultado = new DataTable();
            vw_EstadoCuenta estadoCuenta = new vw_EstadoCuenta();
            resultado = estadoCuenta.ConsultarMovimientos(id.Trim());
            DataGridViewCellStyle cellStyle = new DataGridViewCellStyle();
            cellStyle.Alignment = DataGridViewContentAlignment.MiddleRight;
            cellStyle.Format = "c";
            dGViewEstadoCuenta.DataSource = resultado;
            dGViewEstadoCuenta.Columns["Cargo"].DefaultCellStyle = cellStyle;
            dGViewEstadoCuenta.Columns["Abono"].DefaultCellStyle = cellStyle;
        }
        private void EstadoCuentaProcesaArchivoExcel()
        {
            precarga.AsignastatusProceso("Procesando Estado de Cuenta");
            vw_Clientes cliente = new vw_Clientes();
            cliente = cliente.Consultar(clave_cliente);
            DataTable estadoCuenta = new DataTable();
            vw_EstadoCuenta movimientos = new vw_EstadoCuenta();
            estadoCuenta = movimientos.ConsultarMovimientos(clave_cliente);
            string archivoTemporal = Path.GetTempFileName().Replace(".tmp", ".xls");
            precarga.AsignastatusProceso("Creando archivo de excel...");
            movimientos.GeneraArchivoExcel(archivoTemporal, estadoCuenta, cliente);
            //System.Diagnostics.Process.Start(archivoTemporal);
            FuncionalidadesFormularios.MostrarExcel(archivoTemporal);
        }
        private void btnEstadoCuenta_Click(object sender, EventArgs e)
        {
            tipoTarea = Enumerados.TipoTareaProcesamiento.ReporteEstadoCuenta;
            precarga.MostrarEspera();
            backgroundWorker.RunWorkerAsync();
        }
        void backgroundWorker_DoWork(object sender, DoWorkEventArgs e)
        {
            if (tipoTarea == Enumerados.TipoTareaProcesamiento.ReporteEstadoCuenta)
            {
                EstadoCuentaProcesaArchivoExcel();
            }

        }
        #endregion "Código para el estado de cuenta"


        #region General

        private int SiguienteConsecutivo(string Proceso)
        {
            int consResult = 0;
            int cons = 0;
            int subStrLen = 0;
            List<int> lstConsecutivos = new List<int>();

            if (clave_cliente.Length == 3)
            {
                subStrLen = 6;
            }
            else
            {
                subStrLen = 5;
            }

            var queryProceso = from consecutivo in logotiposOri.AsEnumerable() where consecutivo["COD_CATALOGO"].ToString().ToUpper().Contains("RND-") == false && consecutivo["COD_CATALOGO"].ToString().ToUpper().Substring(consecutivo["COD_CATALOGO"].ToString().IndexOf("-") + 1, consecutivo["COD_CATALOGO"].ToString().Length - consecutivo["COD_CATALOGO"].ToString().IndexOf("-", subStrLen) - 1) == Proceso select consecutivo;
            foreach (DataRow row in queryProceso)
            {
                cons = int.Parse(row["COD_CATALOGO"].ToString().Substring(row["COD_CATALOGO"].ToString().Length - 2, 2));
                lstConsecutivos.Add(cons);
            }
            if (lstConsecutivos.Count > 0)
            {
                lstConsecutivos.Sort();
                consResult = lstConsecutivos.Last() + 1;
            }
            else
            {
                consResult = 1;
            }
            return consResult;
        }
        private string LogosVAlidaCodigoCatalogo()
        {
            string respuestaError = "";
            string[] separador = { "-" };
            string[] elementos = txtLogoCodCatalogo.Text.Split(separador, StringSplitOptions.RemoveEmptyEntries);

            if (elementos.Count() == 3)
            {

                string proceso = elementos[1].ToUpper();
                int consecutivo = 0;

                int.TryParse(elementos[2].Trim(), out consecutivo);

                int siguienteConsecutivo = SiguienteConsecutivo(proceso);


                proceso = elementos[1].ToUpper();

                /*
                if (logotipoNuevo)
                {
                    //consecutivo escrito vs siguiente consecutivo según Proceso:
                        


                        
                    if (consecutivo != siguienteConsecutivo)
                    {
                        respuestaError =
                            "El número consecutivo que ha escrito es incorrecto, el siguiente consecutivo válido es: " +
                            siguienteConsecutivo.ToString("00");
                    }
                         
                    respuestaError = "";
                }
                else
                {*/
                if (txtLogoCodCatalogo.Text != CURR_COD_CLIENTE) // si modificó el código de catálogo...
                {
                    //reviso que el códifgo escrito no exista
                    var query = from cod in logotiposOri.AsEnumerable()
                                where
                                    cod["COD_CATALOGO"].ToString().Trim() == txtLogoCodCatalogo.Text &&
                                    cod["COD_CATALOGO"].ToString().Trim() != CURR_COD_CLIENTE
                                select cod;

                    if (query.Any())
                    {
                        foreach (DataRow dataRow in query)
                        {
                            System.Diagnostics.Debug.WriteLine(dataRow["COD_CATALOGO"]);
                        }
                        respuestaError = "El Código de Catálogo escrito ya pertenece a otro logotipo, verifique";
                    }
                    /*else
                    {
                        if (consecutivo != siguienteConsecutivo)
                        {
                            respuestaError =
                                "El número consecutivo que ha escrito es incorrecto, el siguiente consecutivo válido es: " +
                                siguienteConsecutivo.ToString("00");
                        }
                    }*/
                }
                //}




            }
            else
            {
                respuestaError = "El código del catálogo no contiene el formato correcto.\n Formato correcto: cliente-procesos-consecutivo imágen.";
            }

            return respuestaError;
        }
        private bool GeneralesExistenDatosVacios(List<TextBox> txts)
        {
            bool datoRetorno = false;
            errorProvider1.Clear();
            foreach (TextBox txt in txts)
            {
                if (string.IsNullOrWhiteSpace(txt.Text))
                {
                    errorProvider1.SetError(txt, "Debe escribir un valor.");
                    datoRetorno = true;
                }
            }
            return datoRetorno;

        }
        private bool GeneralesExistenDatosVacios(List<ComboBox> cmbs)
        {
            bool datoRetorno = false;
            errorProvider1.Clear();
            foreach (ComboBox cmb in cmbs)
            {
                if (string.IsNullOrWhiteSpace(cmb.Text))
                {
                    errorProvider1.SetError(cmb, "Debe seleccionar un valor.");
                    datoRetorno = true;
                }
            }
            return datoRetorno;

        }

        public frmFindClie(string idCliente)
        {
            InitializeComponent();
            precarga = new Precarga(this);
            tmrCargaDatos.Tick += tmrCargaDatos_Tick;
            tmrCargaDatos.Interval = 150;
            id_Cliente = idCliente;
            backgroundWorker.DoWork += backgroundWorker_DoWork;
            backgroundWorker.RunWorkerCompleted += backgroundWorker_RunWorkerCompleted;
            bgwInfoCliente.DoWork += bgwInfoCliente_DoWork;
            bgwInfoCliente.RunWorkerCompleted += bgwInfoCliente_RunWorkerCompleted;
        }

        void tmrCargaDatos_Tick(object sender, EventArgs e)
        {
            tmrCargaDatos.Enabled = false;
            precarga.MostrarEspera();
            bgwInfoCliente.RunWorkerAsync(id_Cliente);
            tmrCargaDatos.Enabled = false;


        }

        void bgwInfoCliente_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            precarga.RemoverEspera();

        }

        void bgwInfoCliente_DoWork(object sender, DoWorkEventArgs e)
        {
            System.Diagnostics.Stopwatch stopW = System.Diagnostics.Stopwatch.StartNew();
            string idCliente = (string)e.Argument;

            clave_cliente = idCliente.Trim();

            System.Diagnostics.Debug.WriteLine("Cargando ClienteLlenaDatos()", stopW.Elapsed.ToString());
            ClienteLlenaDatos(clave_cliente);
            System.Diagnostics.Debug.WriteLine("Cargando EstadoCuentaLlenaDatos()", stopW.Elapsed.ToString());
            EstadoCuentaLlenaDatos(clave_cliente);
            System.Diagnostics.Debug.WriteLine("Cargando PedidosSIPLlenaDatos()", stopW.Elapsed.ToString());
            PedidosSIPLlenaDatos(clave_cliente);
            System.Diagnostics.Debug.WriteLine("Cargando LogotiposLlenaDatos()", stopW.Elapsed.ToString());
            LogotiposLlenaDatos();
            System.Diagnostics.Debug.WriteLine("Cargando LogotiposCargaListViewConImagenes()", stopW.Elapsed.ToString());
            LogotiposCargaListViewConImagenes(0);
            System.Diagnostics.Debug.WriteLine("Cargando OrdenTrabSIPLlenaDatos()", stopW.Elapsed.ToString());
            OrdenTrabSIPLlenaDatos(clave_cliente);
            System.Diagnostics.Debug.WriteLine("Cargando Permisos()", stopW.Elapsed.ToString());
            PermisosDePantalla();
            System.Diagnostics.Debug.WriteLine("Cargando PedidosDATSIPLlenaDatos()", stopW.Elapsed.ToString());
            PedidosDATSIPLlenaDatos(clave_cliente);
        }

        private void PermisosDePantalla()
        {

            btnLogoNuevReg.Enabled = ulp_bl.Reportes.PermisosUsuarioEspeciales.TienePermisos(Globales.UsuarioActual.Id, 6, 99);
            btnLogoCambImg.Enabled = ulp_bl.Reportes.PermisosUsuarioEspeciales.TienePermisos(Globales.UsuarioActual.Id, 6, 100);
            btnLogoSalvar.Enabled = ulp_bl.Reportes.PermisosUsuarioEspeciales.TienePermisos(Globales.UsuarioActual.Id, 6, 101);
            btnLogoBorrar.Enabled = ulp_bl.Reportes.PermisosUsuarioEspeciales.TienePermisos(Globales.UsuarioActual.Id, 6, 102);
            btnLogoImprimir.Enabled = ulp_bl.Reportes.PermisosUsuarioEspeciales.TienePermisos(Globales.UsuarioActual.Id, 6, 103);


            //accesaTab1 = ulp_bl.Reportes.PermisosUsuarioEspeciales.TienePermisos(Globales.UsuarioActual.Id, 6, 107);
            accesaTab1 = true;
            accesaTab2 = ulp_bl.Reportes.PermisosUsuarioEspeciales.TienePermisos(Globales.UsuarioActual.Id, 6, 108);
            accesaTab3 = ulp_bl.Reportes.PermisosUsuarioEspeciales.TienePermisos(Globales.UsuarioActual.Id, 6, 109) && this.status == "A";
            accesaTab4 = ulp_bl.Reportes.PermisosUsuarioEspeciales.TienePermisos(Globales.UsuarioActual.Id, 6, 110);
            accesaTab5 = ulp_bl.Reportes.PermisosUsuarioEspeciales.TienePermisos(Globales.UsuarioActual.Id, 6, 111);
            accesaTab6 = ulp_bl.Reportes.PermisosUsuarioEspeciales.TienePermisos(Globales.UsuarioActual.Id, 6, 109) && this.status == "A";

            accesosTabs[0] = accesaTab1;
            accesosTabs[1] = accesaTab2;
            accesosTabs[2] = accesaTab3;
            accesosTabs[3] = accesaTab4;
            accesosTabs[4] = accesaTab5;
            accesosTabs[5] = accesaTab6;


            //if (this.InvokeRequired)
            //{

            //    this.Invoke((MethodInvoker)delegate()
            //    {
            //        //if (!accesaTab1) { tabControl1.TabPages.Remove(tabPage1); }
            //        if (!accesaTab2) { tabControl1.TabPages.Remove(tabPage2); }
            //        if (!accesaTab3) { tabControl1.TabPages.Remove(tabPage3); }
            //        if (!accesaTab4) { tabControl1.TabPages.Remove(tabPage4); }
            //        if (!accesaTab5) { tabControl1.TabPages.Remove(tabPage5); }

            //        if (!accesaTab1 && !accesaTab2 && !accesaTab3 && !accesaTab4 && !accesaTab5)
            //        {
            //            Font font = new System.Drawing.Font(SystemFonts.DefaultFont, FontStyle.Bold);

            //            TabPage tp = new TabPage("SOLICITE PERMISOS");
            //            tp.Controls.Add(new Label()
            //            {
            //                Text =
            //                    "Solicite el acceso a:\n\n-Datos del cliente\n-Estado de cuenta\n-Pedidos en SIP\n-Logotipos\n-Ordenes de trabajo\n\nal área de SISTEMAS",
            //                Font = font,
            //                ForeColor = Color.FromArgb(0, 0, 255),
            //                Location = new Point(32, 32),
            //                AutoSize = true
            //            });

            //            tabControl1.Controls.Add(tp);
            //        }

            //    });
            //}

        }

        void backgroundWorker_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            precarga.RemoverEspera();
        }
        #endregion "Código General"


        #region DatosGeneralesCiente
        private void ClienteLlenaDatos(string id)
        {

            this.Invoke((MethodInvoker)delegate
            {
                vw_Clientes cliente = new vw_Clientes();
                cliente = cliente.Consultar(id);
                lblClave.Text = cliente.CLAVE.Trim();
                lblCP.Text = cliente.CODIGO;
                lblRazonSoc.Text = cliente.NOMBRE_CLIENTE;
                lblDireccion.Text = cliente.DIRECCION;
                lblTelefono.Text = cliente.TELEFONO;
                lblAtencion.Text = cliente.ATENCION;
                lblRFC.Text = cliente.RFC;
                lblVendedor.Text = cliente.NOMBRE_VENDEDOR;
                nombre_vendedor = cliente.NOMBRE_VENDEDOR;
                lblZona.Text = cliente.TEXTO;
                lblDescuento.Text = cliente.DESCUENTO.ToString();
                lblDiasCred.Text = cliente.DIAS_CRE.ToString();
                Termino = cliente.DIAS_CRE.ToString();
                if (cliente.CVE_VEND != null)
                {
                    Agente = cliente.CVE_VEND.ToString();
                }
                else
                {
                    MessageBox.Show("Este cliente no tiene un Vendedor asignado", "Verifique", MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                }
                lblUltComp.Text = cliente.FCH_ULTCOM.ToString();
                lblPzUltAnio.Text = cliente.PZAULTANIO.ToString();
                lblLimiteCred.Text = cliente.LIM_CRED.ToString("C", CultureInfo.CurrentCulture);
                lblCredDisponible.Text = cliente.CRED_DISPO.ToString("C", CultureInfo.CurrentCulture);
                lblSaldo.Text = cliente.SALDO.ToString("C", CultureInfo.CurrentCulture);
                lblObservaciones.Text = cliente.CL8;
                Text = string.Format("CLAVE: {0} - {1}", lblClave.Text, lblRazonSoc.Text);
                this.status = cliente.STATUS;
            });


        }
        #endregion "Código para llenar los datos generales de un cliente"

        #region Pedidos DAT SIP

        private void PedidosDATSIPHabilitaControlesNavegacionParaPrimerRegistro(bool Habilita)
        {
            toolStripBtnPedidosDATSIPGuardar.Enabled = Habilita;
            toolStripBtnPedidosDATSIPEliminar.Enabled = Habilita;
        }
        private void PedidosDATSIPHabilitaControlesNavegacion(bool Habilita)
        {
            bindingNavigatorMoveFirstItemDAT.Enabled = Habilita;
            bindingNavigatorMovePreviousItemDAT.Enabled = Habilita;
            bindingNavigatorMoveNextItemDAT.Enabled = Habilita;
            bindingNavigatorMoveLastItemDAT.Enabled = Habilita;
            toolStripBtnPedidosDATSIPNuevo.Enabled = Habilita;
            bindingNavigatorPositionItemDAT.Enabled = Habilita;
        }
        private void PedidosDATSIPHabilitaControlesCambios(bool Habilita)
        {
            lblPedDATSIPYaImpreso.Visible = !Habilita;
            txtPedDATSIPOc.Enabled = Habilita;
            txtPedDATSIPRemitido.Enabled = Habilita;
            txtPedDATSIPConsignado.Enabled = Habilita;
            txtPedDATSIPObservaciones.Enabled = Habilita;
            btnPedDATSIPAgregarPartidas.Enabled = Habilita;
            btnPedDATSIPElimModPartidas.Enabled = Habilita;
            btnPedDATSIPTerminosActualiza.Enabled = Habilita;
            toolStripBtnPedidosDATSIPGuardar.Enabled = Habilita;
            btnPedDATSIPImprimir.Enabled = Habilita;
            txtPedDATSIPConsignado.Enabled = Habilita;
        }
        private void PedidosDATSIPEvaluaHabilitarControlesCambios()
        {
            if (bindingSourcePedidosDATSIP.Count > 0)
            {
                DataRowView row = (DataRowView)bindingSourcePedidosDATSIP.Current;
                string status = row["ESTATUS"].ToString();
                if (status == "I")
                {
                    PedidosDATSIPHabilitaControlesCambios(false);
                    btnPedDATSIPImprimir.Enabled = true;
                }
                else
                {
                    PedidosDATSIPHabilitaControlesCambios(true);
                }
            }
            else
            {
                PedidosDATSIPHabilitaControlesNavegacionParaPrimerRegistro(false);
                PedidosDATSIPHabilitaControlesCambios(false);
                lblPedDATSIPYaImpreso.Visible = false;
            }

        }
        private void PedidosDATSIPLlenaDatos(string id)
        {
            PED_MSTR pedidosBl = new PED_MSTR();
            pedidosDAT = pedidosBl.CosultarPedidosDATCliente(id);
            bindingSourcePedidosDATSIP.DataSource = pedidosDAT;

            txtPedDATSIPNo.DataBindings.Add("Text", bindingSourcePedidosDATSIP, "PEDIDO");
            txtPedDATSIPFecha.DataBindings.Add("Text", bindingSourcePedidosDATSIP, "FECHA");
            txtPedDATSIPAgente.DataBindings.Add("Text", bindingSourcePedidosDATSIP, "AGENTE");
            txtPedDATSIPCliente.DataBindings.Add("Text", bindingSourcePedidosDATSIP, "CLIENTE");
            txtPedDATSIPOc.DataBindings.Add("Text", bindingSourcePedidosDATSIP, "OC");
            txtPedDATSIPTerminos.DataBindings.Add("Text", bindingSourcePedidosDATSIP, "TERMINOS");
            txtPedDATSIPRemitido.DataBindings.Add(new Binding("Text", bindingSourcePedidosDATSIP, "REMITIDO", true));
            txtPedDATSIPConsignado.DataBindings.Add(new Binding("Text", bindingSourcePedidosDATSIP, "CONSIGNADO", true));
            txtPedDATSIPObservaciones.DataBindings.Add(new Binding("Text", bindingSourcePedidosDATSIP, "OBSERVACIONES", true));
            cmbPedDATSIPFormaPago.DataBindings.Add(new Binding("SelectedValue", bindingSourcePedidosDATSIP, "FORMADEPAGOSAT", true));
            cmbPedDATSIPUsoCFDI.DataBindings.Add(new Binding("SelectedValue", bindingSourcePedidosDATSIP, "USO_CFDI", true));
            cmbPedDATSIPMetodoPago.DataBindings.Add(new Binding("SelectedValue", bindingSourcePedidosDATSIP, "METODODEPAGO", true));
            lblPedDATSIPDescuento.DataBindings.Add("Text", bindingSourcePedidosDATSIP, "DESCUENTO");




            bindingNavigatorPedidosDATSIP.BindingSource = bindingSourcePedidosDATSIP;
            PedidosDATSIPEvaluaHabilitarControlesCambios();
            txtPedDATSipAValidar.Add(txtPedDATSIPRemitido);
            cmbPedDATSipAValidar.Add(cmbPedDATSIPFormaPago);
            cmbPedDATSipAValidar.Add(cmbPedDATSIPUsoCFDI);
            cmbPedDATSipAValidar.Add(cmbPedDATSIPMetodoPago);
        }
        private string PedidosDATSIPModificar()
        {
            string resultado = "";
            PED_MSTR pedidoModifica = new PED_MSTR();
            pedidoModifica.OC = txtPedDATSIPOc.Text;
            pedidoModifica.TERMINOS = txtPedDATSIPTerminos.Text;
            pedidoModifica.REMITIDO = txtPedDATSIPRemitido.Text;
            pedidoModifica.CONSIGNADO = txtPedDATSIPConsignado.Text;
            pedidoModifica.OBSERVACIONES = txtPedDATSIPObservaciones.Text;
            pedidoModifica.PEDIDO = Convert.ToInt32(txtPedDATSIPNo.Text);
            pedidoModifica.FORMADEPAGOSAT = cmbPedDATSIPFormaPago.SelectedValue.ToString();
            pedidoModifica.USO_CFDI = cmbPedDATSIPUsoCFDI.SelectedValue.ToString();
            pedidoModifica.METODODEPAGO = cmbPedDATSIPMetodoPago.SelectedValue.ToString();
            //pedidoModifica.DESCUENTO = txtPedDATSIPDescuento.Text == "" ? 0 : double.Parse(txtPedDATSIPDescuento.Text) / 100;
            pedidoModifica.Modificar(pedidoModifica);
            if (pedidoModifica.TieneError)
            {
                resultado = pedidoModifica.Error.InnerException.ToString();
            }
            return resultado;
        }
        private string PedidosDATSIPGuardar()
        {
            string resultado = "";
            int pedido = 0;
            PED_MSTR guardaPedido = new PED_MSTR();
            guardaPedido.AGENTE = Agente;
            guardaPedido.FECHA = Convert.ToDateTime(txtPedDATSIPFecha.Text);
            guardaPedido.CLIENTE = txtPedDATSIPCliente.Text;
            guardaPedido.OC = txtPedDATSIPOc.Text;
            guardaPedido.TERMINOS = Termino;
            guardaPedido.REMITIDO = txtPedDATSIPRemitido.Text;
            guardaPedido.CONSIGNADO = txtPedDATSIPConsignado.Text;
            guardaPedido.OBSERVACIONES = txtPedDATSIPObservaciones.Text;
            guardaPedido.TIPO = "DT";
            guardaPedido.LISTA = 1;
            guardaPedido.ESTATUS = "P";
            guardaPedido.FORMADEPAGOSAT = cmbPedDATSIPFormaPago.SelectedValue.ToString();
            guardaPedido.USO_CFDI = cmbPedDATSIPUsoCFDI.SelectedValue.ToString();
            guardaPedido.METODODEPAGO = cmbPedDATSIPMetodoPago.SelectedValue.ToString();
            //guardaPedido.DESCUENTO = txtPedDATSIPDescuento.Text == "" ? 0 : double.Parse(txtPedDATSIPDescuento.Text);
            guardaPedido.Crear(guardaPedido, ref pedido);
            if (!guardaPedido.TieneError)
            {
                UPPEDIDOS guardaUppedidos = new UPPEDIDOS();
                guardaUppedidos.PEDIDO = pedido;
                guardaUppedidos.COD_CLIENTE = clave_cliente;
                guardaUppedidos.F_CAPT = DateTime.Now;
                guardaUppedidos.Crear(guardaUppedidos);

                txtPedDATSIPNo.Text = pedido.ToString();
                pedidosDAT.Rows[pedidosDAT.Rows.Count - 1]["PEDIDO"] = pedido;
            }
            else
            {
                resultado = guardaPedido.Error.InnerException.ToString();
            }
            return resultado;
        }

        private void btnPedDATSIPTerminosActualiza_Click(object sender, EventArgs e)
        {
            txtPedDATSIPTerminos.Text = Termino;
            string resultado = "";
            resultado = PedidosDATSIPModificar();
            if (resultado != "")
            {
                MessageBox.Show("Se presentó el siguiente error \\n" + resultado, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }
        private void toolStripBtnPedidosDATSIPNuevo_Click(object sender, EventArgs e)
        {
            pedidoDATNuevo = true;

            DataRow nuevo_pedido = pedidosDAT.NewRow();
            pedidosDAT.Rows.Add(nuevo_pedido);
            nuevo_pedido["FECHA"] = DateTime.Now;
            nuevo_pedido["AGENTE"] = Agente;
            nuevo_pedido["CLIENTE"] = clave_cliente;
            nuevo_pedido["OC"] = "";
            nuevo_pedido["TERMINOS"] = Termino;
            nuevo_pedido["ESTATUS"] = "P";
            nuevo_pedido["FORMADEPAGOSAT"] = "03";
            nuevo_pedido["METODODEPAGO"] = "PUE";
            nuevo_pedido["USO_CFDI"] = "G01";
            bindingSourcePedidosDATSIP.MoveLast();

            PedidosDATSIPHabilitaControlesNavegacion(false);
            PedidosDATSIPHabilitaControlesCambios(true);
            btnPedDATSIPAgregarPartidas.Enabled = false;
            btnPedDATSIPElimModPartidas.Enabled = false;
            btnPedDATSIPTerminosActualiza.Enabled = false;
            btnPedDATSIPImprimir.Enabled = false;
            PedidosDATSIPHabilitaControlesNavegacionParaPrimerRegistro(true);
            txtPedDATSIPOc.Focus();
        }
        private void toolStripBtnPedidosDATSIPGuardar_Click(object sender, EventArgs e)
        {
            if (!GeneralesExistenDatosVacios(txtPedDATSipAValidar) && !GeneralesExistenDatosVacios(cmbPedDATSipAValidar))
            {
                string resultado = "";
                if (pedidoDATNuevo)
                {
                    resultado = PedidosDATSIPGuardar();
                }
                else
                {
                    resultado = PedidosDATSIPModificar();
                }

                if (resultado == "")
                {
                    PedidosDATSIPHabilitaControlesNavegacion(true);
                    PedidosDATSIPHabilitaControlesCambios(true);
                    pedidoDATNuevo = false;
                }
                else
                {
                    MessageBox.Show("Se presentó el siguiente error \\n" + resultado, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }
        private void toolStripBtnPedidosDATSIPEliminar_Click(object sender, EventArgs e)
        {
            if (!pedidoDATNuevo)
            {
                PED_DET detalle_pedido = new PED_DET();
                int idPedido = Convert.ToInt32(txtPedDATSIPNo.Text);
                bool contiene_partidas = detalle_pedido.ContieneRegistrosPedido(idPedido);
                if (!contiene_partidas)
                {
                    if (MessageBox.Show("Está seguro que desea eliminar el pedido?", "", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
                    {
                        PED_MSTR elimina_pedido = new PED_MSTR();
                        elimina_pedido.PEDIDO = idPedido;
                        elimina_pedido.Borrar(elimina_pedido, Enumerados.TipoBorrado.Fisico);
                        bindingSourcePedidosDATSIP.RemoveCurrent();
                        MessageBox.Show("El pedido ha sido eliminado.", "Información", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                }
                else
                {
                    MessageBox.Show("No se puede eliminar el pedido debido a que ya tiene partidas cargadas.\n\n Debe eliminar las partidas desde el botón (Eliminar o Modificar Partidas) y luego podrá eliminar el pedido", "Información", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
            else
            {
                bindingSourcePedidosDATSIP.RemoveCurrent();
                PedidosDATSIPHabilitaControlesNavegacion(true);
                PedidosDATSIPEvaluaHabilitarControlesCambios();
                pedidoDATNuevo = false;
            }
            if (bindingSourcePedidosDATSIP.Count == 0)
            {
                PedidosDATSIPHabilitaControlesNavegacionParaPrimerRegistro(false);
            }
        }
        private void btnPedDATSIPElimModPartidas_Click(object sender, EventArgs e)
        {
            frmEliminarPartidas frmEliminarPartidas = new frmEliminarPartidas(clave_cliente, Convert.ToInt32(txtPedDATSIPNo.Text), Enumerados.TipoPedido.Pedido);
            frmEliminarPartidas.Show();
        }
        private void btnPedDATSIPAgregarPartidas_Click(object sender, EventArgs e)
        {
            if (!string.IsNullOrEmpty(txtPedDATSIPCliente.Text))
            {
                /*
                frmAgregarPartidas = new AddPartidasPedi(txtPedSIPCliente.Text,
                    Convert.ToInt32(txtPedSIPNo.Text), Enumerados.TipoPedido.Pedido, nombre_vendedor);
                frmAgregarPartidas.Show();
                 * */
                frmAgregarPartidas = new AddPartidasPedi2(txtPedDATSIPCliente.Text, Convert.ToInt32(txtPedDATSIPNo.Text), Enumerados.TipoPedido.Pedido, nombre_vendedor, true);
                frmAgregarPartidas.Show();
            }
        }
        private void bindingNavigatorMovePreviousItemDAT_Click(object sender, EventArgs e)
        {
            PedidosDATSIPEvaluaHabilitarControlesCambios();
        }
        private void bindingNavigatorMoveNextItemDAT_Click(object sender, EventArgs e)
        {
            PedidosDATSIPEvaluaHabilitarControlesCambios();
        }
        private void bindingNavigatorMoveFirstItemDAT_Click(object sender, EventArgs e)
        {
            PedidosDATSIPEvaluaHabilitarControlesCambios();
        }
        private void bindingNavigatorMoveLastItemDAT_Click(object sender, EventArgs e)
        {
            PedidosDATSIPEvaluaHabilitarControlesCambios();
        }
        #endregion


        private void frmFindClie_Load(object sender, EventArgs e)
        {
            try
            {
                DataTable dtCatalogoFormaPago = Catalogos.GetCatalogoFormaPago();
                DataTable dtCatalogoUsoCFDI = Catalogos.GetCatalogoUsoCFDI();
                DataTable dtCatalogoMetodoPago = Catalogos.GetCatalogoMetodoPago();


                //SE CARGAN CATALOGOS 
                cmbPedSIPFormaPago.DisplayMember = "Descripcion";
                cmbPedSIPFormaPago.ValueMember = "Clave";
                cmbPedSIPFormaPago.DataSource = dtCatalogoFormaPago;
                cmbPedSIPFormaPago.SelectedValue = "03";
                cmbPedDATSIPFormaPago.DisplayMember = "Descripcion";
                cmbPedDATSIPFormaPago.ValueMember = "Clave";
                cmbPedDATSIPFormaPago.DataSource = dtCatalogoFormaPago;
                cmbPedDATSIPFormaPago.SelectedValue = "03";

                cmbPedSIPUsoCFDI.DisplayMember = "Descripcion";
                cmbPedSIPUsoCFDI.ValueMember = "Clave";
                cmbPedSIPUsoCFDI.DataSource = dtCatalogoUsoCFDI;
                cmbPedSIPUsoCFDI.SelectedValue = "G01";
                cmbPedDATSIPUsoCFDI.DisplayMember = "Descripcion";
                cmbPedDATSIPUsoCFDI.ValueMember = "Clave";
                cmbPedDATSIPUsoCFDI.DataSource = dtCatalogoUsoCFDI;
                cmbPedDATSIPUsoCFDI.SelectedValue = "G01";

                cmbPedSIPMetodoPago.DisplayMember = "Descripcion";
                cmbPedSIPMetodoPago.ValueMember = "Clave";
                cmbPedSIPMetodoPago.DataSource = dtCatalogoMetodoPago;
                cmbPedSIPMetodoPago.SelectedValue = "PUE";
                cmbPedDATSIPMetodoPago.DisplayMember = "Descripcion";
                cmbPedDATSIPMetodoPago.ValueMember = "Clave";
                cmbPedDATSIPMetodoPago.DataSource = dtCatalogoMetodoPago;
                cmbPedDATSIPMetodoPago.SelectedValue = "PUE";
            }
            catch { }
        }

        private void frmFindClie_Activated(object sender, EventArgs e)
        {
            if (!DatosCrgados)
            {
                tmrCargaDatos.Enabled = true;
                DatosCrgados = true;

            }
            if (frmReportes != null)
            {
                if (tipoPedido == Enumerados.TipoPedido.Pedido)
                {
                    if (frmReportes.pedidoEstatusModificado)
                    {
                        if (bindingSourcePedidosSIP.Position >= 0)
                            pedidos.Rows[bindingSourcePedidosSIP.Position]["ESTATUS"] = "I";
                        if (bindingSourcePedidosDATSIP.Position >= 0)
                            pedidosDAT.Rows[bindingSourcePedidosDATSIP.Position]["ESTATUS"] = "I";
                        PedidosDATSIPEvaluaHabilitarControlesCambios();
                    }
                }
                else if (tipoPedido == Enumerados.TipoPedido.OrdenTrabajo)
                {
                    if (frmReportes.pedidoEstatusModificado)
                    {

                        OrdenTrabajo.Rows[bindingSourceOrdenTrabSIP.Position]["ESTATUS"] = "I";
                        OrdenTrabHabilitaControlesCambios(false);
                    }
                }

            }
            if (frmAgregarPartidas != null)
            {
                if (frmAgregarPartidas.pedidoEstatusModificado)
                {
                    if (bindingSourcePedidosSIP.Position >= 0)
                        pedidos.Rows[bindingSourcePedidosSIP.Position]["ESTATUS"] = "I";
                    if (bindingSourcePedidosDATSIP.Position >= 0)
                        pedidosDAT.Rows[bindingSourcePedidosDATSIP.Position]["ESTATUS"] = "I";
                    PedidosSIPEvaluaHabilitarControlesCambios();
                    PedidosDATSIPEvaluaHabilitarControlesCambios();
                }
            }

        }

        private void tabControl1_SelectedIndexChanged(object sender, EventArgs e)
        {

        }

        private void tabControl1_Selected(object sender, TabControlEventArgs e)
        {
            switch (e.TabPageIndex)
            {
                case 2:
                    tipoPedido = Enumerados.TipoPedido.Pedido;
                    this.WindowState = FormWindowState.Normal;
                    break;
                case 3:
                    this.WindowState = FormWindowState.Maximized;
                    break;
                case 4:
                    tipoPedido = Enumerados.TipoPedido.OrdenTrabajo;
                    this.WindowState = FormWindowState.Normal;
                    break;
                default:
                    tipoPedido = Enumerados.TipoPedido.NoAplica;
                    this.WindowState = FormWindowState.Normal;
                    break;
            }

        }

        private void bindingNavigatorMoveFirstItem1_Click(object sender, EventArgs e)
        {
            OrdenTrabEvaluaHabilitarControlesCambios();
        }

        private void bindingNavigatorMovePreviousItem1_Click(object sender, EventArgs e)
        {
            OrdenTrabEvaluaHabilitarControlesCambios();
        }

        private void bindingNavigatorMoveNextItem1_Click(object sender, EventArgs e)
        {
            OrdenTrabEvaluaHabilitarControlesCambios();
        }

        private void bindingNavigatorMoveLastItem1_Click(object sender, EventArgs e)
        {
            OrdenTrabEvaluaHabilitarControlesCambios();
        }

        private void txtLogoCodCatalogo_TextChanged(object sender, EventArgs e)
        {
            try
            {
                string[] datos = txtLogoCodCatalogo.Text.Split('-');
                if (datos.Length == 3)
                {
                    if (!string.IsNullOrEmpty(datos[1]))
                    {
                        lblSigConsecutivo.Text = string.Format("<--[ {0} ] Siguiente consecutivo para: \"{1}\"", SiguienteConsecutivo(datos[1].ToUpper()).ToString("00"), datos[1].ToUpper());
                    }
                }
                else
                {
                    lblSigConsecutivo.Text = "<-- ??";
                }
            }
            catch (Exception Ex)
            {
                lblSigConsecutivo.Text = "<-- ??";
            }

        }

        private void tabControl1_Selecting(object sender, TabControlCancelEventArgs e)
        {

            if (!accesosTabs[e.TabPageIndex])
            {
                if (this.status != "A")
                    MessageBox.Show("El Cliente no está Activo, por lo tanto no se permite el accesos a esta opción.", "", MessageBoxButtons.OK, MessageBoxIcon.Information);
                else
                    MessageBox.Show("Solicite acceso al administrador del Sistema", "", MessageBoxButtons.OK, MessageBoxIcon.Information);
                e.Cancel = true;
            }

        }

        private void toolStripBtnBuscar_Click(object sender, EventArgs e)
        {
            frmInputBox frmInputBox = new SIP.frmInputBox(Enumerados.TipoCajaTextoInputBox.Numerica);

            frmInputBox.lblTitulo.Text = "Escriba el número de pedido";
            frmInputBox.Text = "Búsqueda de pedido";

            if (frmInputBox.ShowDialog() == System.Windows.Forms.DialogResult.OK)
            {

                int pos = bindingSourcePedidosSIP.Find("Pedido", frmInputBox.NTxtOrden.Text);
                if (pos != -1)
                {
                    tmrTextBoxHilight = new Timer();
                    tmrTextBoxHilight.Tick += tmrTextBoxHilight_Tick;
                    tmrTextBoxHilight.Interval = 250;
                    tmrTextBoxHilight.Enabled = true;
                    bindingSourcePedidosSIP.Position = pos;
                }
                else
                {
                    MessageBox.Show("No se encontró número de pedido", "", MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                    toolStripBtnBuscar_Click(sender, e);
                }
            }

        }

        private int tmrTxtHiLightCont = 0;
        private int tmrTxtHiLightTot = 8;
        void tmrTextBoxHilight_Tick(object sender, EventArgs e)
        {
            if (tmrTxtHiLightCont <= tmrTxtHiLightTot)
            {
                if (tmrTxtHiLightCont % 2 == 0)
                {
                    txtPedSIPNo.BackColor = Color.Yellow;
                    txtPedSIPNo.BorderStyle = BorderStyle.FixedSingle;
                    txtPedSIPNo.Font = new Font(txtPedSIPNo.Font.FontFamily, txtPedSIPNo.Font.Size, FontStyle.Bold);
                }
                else
                {
                    txtPedSIPNo.BackColor = SystemColors.Control;
                    txtPedSIPNo.BorderStyle = BorderStyle.Fixed3D;
                    txtPedSIPNo.Font = new Font(txtPedSIPNo.Font.FontFamily, txtPedSIPNo.Font.Size, FontStyle.Regular);
                }
                tmrTxtHiLightCont++;
            }
            if (tmrTxtHiLightCont == tmrTxtHiLightTot)
            {
                txtPedSIPNo.BackColor = SystemColors.Control;
                txtPedSIPNo.BorderStyle = BorderStyle.Fixed3D;
                txtPedSIPNo.Font = new Font(txtPedSIPNo.Font.FontFamily, txtPedSIPNo.Font.Size, FontStyle.Regular);
                tmrTxtHiLightCont = 0;
                tmrTextBoxHilight.Enabled = false;

            }
        }

        private void btnPedDATSIPImprimir_Click(object sender, EventArgs e)
        {
            if (pedidosDAT.Rows[bindingSourcePedidosDATSIP.Position]["PEDIDO"] != DBNull.Value)
            {
                int idPedido = Convert.ToInt32(pedidosDAT.Rows[bindingSourcePedidosDATSIP.Position]["PEDIDO"].ToString());
                string status = pedidosDAT.Rows[bindingSourcePedidosDATSIP.Position]["ESTATUS"].ToString();
                frmReportes = new Reportes.frmReportes(Enumerados.TipoReporteCrystal.Pedidos,
                    clave_cliente, 0, idPedido, Enumerados.TipoPedido.Pedido, true, double.Parse(pedidosDAT.Rows[bindingSourcePedidosDATSIP.Position]["DESCUENTO"].ToString()));
                if (status == "I")
                {
                    frmReportes.enVentas = true;
                }
                frmReportes.Show();
            }
        }

        private void toolStripBtnBuscarDAT_Click(object sender, EventArgs e)
        {
            frmInputBox frmInputBox = new SIP.frmInputBox(Enumerados.TipoCajaTextoInputBox.Numerica);

            frmInputBox.lblTitulo.Text = "Escriba el número de pedido";
            frmInputBox.Text = "Búsqueda de pedido";

            if (frmInputBox.ShowDialog() == System.Windows.Forms.DialogResult.OK)
            {

                int pos = bindingSourcePedidosDATSIP.Find("Pedido", frmInputBox.NTxtOrden.Text);
                if (pos != -1)
                {
                    tmrTextBoxHilight = new Timer();
                    tmrTextBoxHilight.Tick += tmrTextBoxHilight_Tick;
                    tmrTextBoxHilight.Interval = 250;
                    tmrTextBoxHilight.Enabled = true;
                    bindingSourcePedidosDATSIP.Position = pos;
                }
                else
                {
                    MessageBox.Show("No se encontró número de pedido", "", MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                    toolStripBtnBuscarDAT_Click(sender, e);
                }
            }
        }

    }
}
